name: Deploy (dev) to EC2

on:
  push:
    branches: ["dev"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      WORKDIR: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Build (Gradle)
        working-directory: ${{ env.WORKDIR }}
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      - name: Pick jar
        working-directory: ${{ env.WORKDIR }}
        run: |
          ls -al build/libs
          # plain.jar / original.jar 등을 피해 "실행 가능한 jar"를 우선 선택
          JAR_PATH="$(ls build/libs/*.jar | grep -v -E '(plain|original)\.jar$' | head -n 1)"
          if [ -z "$JAR_PATH" ]; then
            echo "No runnable jar found in build/libs"
            ls -al build/libs
            exit 1
          fi
          echo "JAR_PATH=$JAR_PATH" >> $GITHUB_ENV
          echo "Selected: $JAR_PATH"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Upload jar to EC2
        run: |
          scp -i ~/.ssh/id_rsa \
            "$JAR_PATH" \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/opt/member/app.jar"

      - name: Restart service
        run: |
          ssh -i ~/.ssh/id_rsa "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
            "sudo systemctl restart member && sudo systemctl status member --no-pager -l"

      - name: Health check (Swagger)
        run: |
          # HTTPS가 아니면 http:// 로 바꾸기
          curl -fsS "https://${{ secrets.EC2_HOST }}/swagger-ui/index.html" > /dev/null
          echo "Health check OK"

