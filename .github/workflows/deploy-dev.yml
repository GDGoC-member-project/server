name: Deploy (dev) to EC2

on:
  push:
    branches: ["dev"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      WORKDIR: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Build (Gradle)
        working-directory: ${{ env.WORKDIR }}
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      - name: Pick jar
        working-directory: ${{ env.WORKDIR }}
        run: |
          ls -al build/libs
         
          JAR_PATH="$(ls build/libs/*.jar | grep -v -E '(plain|original)\.jar$' | head -n 1)"
          if [ -z "$JAR_PATH" ]; then
            echo "No runnable jar found in build/libs"
            ls -al build/libs
            exit 1
          fi
          echo "JAR_PATH=$JAR_PATH" >> $GITHUB_ENV
          echo "Selected: $JAR_PATH"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Upload jar to EC2
        run: |
          scp -i ~/.ssh/id_rsa \
            "$JAR_PATH" \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/opt/member/app.jar"

      - name: Restart service
        run: |
          ssh -i ~/.ssh/id_rsa "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
            "sudo systemctl restart member && sudo systemctl status member --no-pager -l"

      - name: Health check (/ with retry)
        run: |
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ secrets.EC2_HOST }}/" || true)
            echo "Attempt $i: HTTP $code"

            # 200 OK / 301-302 Redirect면 "살아있다"로 간주
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "Health check OK"
              exit 0
            fi

            sleep 4
          done

          echo "Health check FAILED"
          exit 1

